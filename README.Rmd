---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  fig.width=12, 
  fig.height=6
)

```

# nowcast birth estimates

<!-- badges: start -->
<!-- badges: end -->
```{r read data, include=FALSE}

library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(gglaplot)

source("R/functions/plot_predicted_births.R")
source("R/functions/get_ts_ratios.R")
source("R/functions/interpolate_gp_ratios.R")
source("R/functions/create_projection_set.R")
source("R/functions/calculate_mean_errors.R")
source("R/functions/calculate_proportion_within_interval.R")
source("R/functions/calculate_forecast_errors.R")

fpath <- list(births_actual = "data/processed/births_actual.rds",
              gp_0 = "data/processed/gp_age_0.rds")

#--- calculate past ratios of births to gp counts ----
births_actual <- readRDS(fpath$births_actual) %>%
  rename(annual_births = value) %>%
  select(-measure)

gp_0 <- readRDS(fpath$gp_0) %>%
  rename(gp_count = value) %>%
  select(-measure)

gp_ratios <- inner_join(births_actual, gp_0,
                        by = c("gss_code", "gss_name", "geography", "date", "sex")) %>%
  mutate(ratio = annual_births/gp_count) %>%
  select(-c(annual_births, gp_count)) %>%
  arrange(gss_code, sex, date)

dates_actual_births <- unique(births_actual$date)
dates_actual_ratios <- unique(gp_ratios$date)

```

```{r set dates to use, include=FALSE}

dt_earliest_to_use <- as.Date("2015-07-01")
max_horizon <- 4

dt_start <- max(min(dates_actual_ratios), dt_earliest_to_use) + months(36)
dt_end <- max(dates_actual_births) - months(max_horizon * 6)

dates_project_from <- seq.Date(dt_start, dt_end, by = "6 months")

```

This repository contains code for producing monthly modelled estimates of annual births for local authorities and higher level geographies in England.

Outputs from this process are published on the London Datastore [here](https://data.london.gov.uk/dataset/modelled-estimates-of-recent-births)

Official birth estimates from ONS are considered very accurate, but the lag between the end of the period covered and the publication of estimates is typically 9-12 months. To gain a more timely indication of birth trends, the GLA Demography team produces modelled estimates of annual births based on counts of infants registered with GP practices. Modelled birth estimates can be produced with the same frequency and latency that [NHS Digital](https://digital.nhs.uk/data-and-information/publications/statistical/patients-registered-at-a-gp-practice) publishes patient count data - currently monthly and with a lag of 1-2 weeks from the extract date.

# Data inputs

The birth and patient count inputs to the process are derived entirely from publicly available data:

1. Patient counts by age and local authority of residence are based on [data published by NHS Digital](https://digital.nhs.uk/data-and-information/publications/statistical/patients-registered-at-a-gp-practice) and modelled into the form used here by the [process-published-nhs-data](https://github.com/Greater-London-Authority/process-published-nhs-data) process.

2. Annual births by local authority are based on official ONS estimates collated from several different publications by the [collate-birth-data](https://github.com/Greater-London-Authority/collate-birth-data) process.

# Setup and usage

The files *births_lad.rds* - output by the [collate-birth-data](https://github.com/Greater-London-Authority/collate-birth-data) process -  and *gp_sya_lad.rds* - an output of [process-published-nhs-data](https://github.com/Greater-London-Authority/process-published-nhs-data) - must be placed in
```
data/raw/
```
[Birth](https://data.london.gov.uk/dataset/birth-estimates) and [patient count data](https://data.london.gov.uk/dataset/patients-registered-at-a-gp-practice) inputs are published on the London Datastore, though these may not reflect the latest available data. 

These inputs are processed into a suitable format by:
```
R/1_process_lad_actual_births.R
```
and
```
R/2_process_lad_gp_data.R
```
These scripts only need to be run when updating birth or patient count data.


Once the input data has been processed, modelled births are produced by:
```
R/3_produce_birth_estimates.R
```

Various files containing actual and predicted births for local authorities, ITL2 subregions, Regions, and countries, as well as the underlying GP count data are output by the process and saved in
```
outputs/
```


Plots of the results for each area can optionally be generated by *4_produce_birth_plots.R* and these are saved in
```
outputs/plots/
```

# Overview of methodology

The approach used to generate the modelled birth estimates was originally described in this [2016 technical note](https://data.london.gov.uk/dataset/estimating-births-using-gp-registration-data). The methodology relies on the strong correlation between the patient register counts of persons age 0 (i.e. yet to reach their first birthday) resident in an area with the number of births that have taken place in that area over the preceding year. 

```{r births & gp counts, echo=FALSE, warning=FALSE}

# City of London and Isles of Scilly are excluded as they are far smaller than other districts
gss_exclude <- c("E09000001", "E06000053") 

plt_gss <- c("E12000007", "E09000028", "TLH3", "E92000001", "E08000025", "E07000099")

gp_births_ratios_plt <- inner_join(births_actual, gp_0,
                        by = c("gss_code", "gss_name", "geography", "date", "sex")) %>%
  mutate(ratio = annual_births/gp_count) %>%
  pivot_longer(cols = c("annual_births", "gp_count", "ratio"), 
               names_to = "measure", values_to = "value") 

gp_births_ratios_plt %>%
  filter(gss_code %in% plt_gss) %>%
  filter(measure != "ratio") %>%
  ggplot(aes(x = date, y = value/1000, colour = measure)) +
  theme_gla(free_y_facets = TRUE, gla_theme = "inverse") +
  geom_point() +
  ggla_line() +
  facet_wrap("gss_name", scales = "free_y") +
  labs(title = "Annual births and persons age 0 on patient register",
       subtitle = "(thousands)",
       caption = "Sources: ONS birth estimates; GLA modelling of NHS Digital patient data")

```

The correlation between births and patient counts tends to be greater at larger geographic areas, such as regions and subregions, than it is for individual local authorities.

```{r correlation_coefficients, echo=FALSE, warning=FALSE}

gp_births_correlation <- inner_join(births_actual, gp_0,
                                    by = c("gss_code", "gss_name", "geography", "date", "sex")) %>%
  filter(date >= dt_earliest_to_use) %>%
  mutate(geog_name = recode(geography,
                            "LAD23" = "Districts",
                            "LAD21" = "Districts",
                            "RNG21" = "Regions",
                            "RNG23" = "Regions",
                            "ITL221" = "ITL2 Subregions")) %>%
  arrange(sex, date) %>%
  group_by(gss_code, gss_name, geography, geog_name, sex) %>%
  summarise(correlation_coefficient = cor(annual_births, gp_count), .groups = "drop")

gp_births_correlation %>%
  filter(!gss_code %in% gss_exclude) %>%
  filter(grepl("LAD", geography)) %>%
  ggplot(aes(x = correlation_coefficient)) +
  theme_gla(free_y_facets = TRUE, x_axis_title = TRUE, gla_theme = "inverse") +
  geom_histogram(bins = 60, fill = gla_pal()[5]) +
  scale_x_continuous(n.breaks = 10) +
  xlab("Correlation coefficient") +
  labs(title = "Distribution of correlation coefficients",
       subtitle = "Local authority districts",
       caption = "Note: Excludes City of London and Isles of Scilly")

gp_births_correlation %>%
  filter(!gss_code %in% gss_exclude) %>%
  filter(grepl("ITL|RGN", geography)) %>%
  ggplot(aes(x = correlation_coefficient, fill = geography)) +
  theme_gla(free_y_facets = TRUE, x_axis_title = TRUE, gla_theme = "inverse") +
  geom_histogram(bins = 60) +
  facet_wrap("geog_name", scales = "free_y", ncol = 2) +
  scale_x_continuous(limits = c(0.9,NA)) +
  xlab("Correlation coefficient") +
  labs(title = "Distribution of correlation coefficients",
       subtitle = "Regions and ITL subregions")
```

Ratios of births to patient register counts vary over time.  The reasons for changes in a given area might include:

* Changing volumes of infant net migration relative to the number of births
* A change in the average period between a child being born and being added to the patient register
* A change in the proportion of infants not included on the patient register at all (e.g. those that engage exclusively wit private healthcare services)
* A change in the average time taken for changes in address to be reflected in the patient register

```{r birth to gp ratio plots, echo=FALSE, warning=FALSE}

gp_births_ratios_plt %>%
  filter(gss_code %in% plt_gss) %>%
  filter(measure == "ratio") %>%
  ggplot(aes(x = date, y = value, colour = gss_name)) +
  theme_gla(free_y_facets = TRUE, gla_theme = "inverse") +
  geom_point() +
  ggla_line() +
  scale_x_date(breaks = dates_actual_ratios, labels = label_date_short()) +
  labs(title = "Ratio of annual births to persons age 0 on patient register",
       caption = "Sources: ONS birth estimates; GLA modelling of NHS Digital patient data")

```

Recent ratios are forecast from the time series of available past data. In the current implementation a simple exponential smoothing method from the *Fable* package is used to do this. For each area, the model returns the mean forecast value of the ratio as well as the 95 percent prediction interval. 

Past ratios are calculated using annual births for mid and calendar year periods and the forecast ratios produced by the time series model have the same frequency. 

Both forecast and past ratios are interpolated to match the monthly frequency of the patient register data. This allows:

* predicted recent births to be updated monthly as each new set of patient count data is released
* creation of annual birth estimates for the months between standard mid-year and calendar year releases (these estimates are labelled as 'interpolated' in the output files)

```{r project ratios, include=FALSE}

ts_ratios <- get_ts_ratios(filter(gp_ratios, gss_code %in% plt_gss),
                           dt_min = dt_earliest_to_use,
                           dt_max = dt_end)

  ts_model <- ts_ratios %>%
    model(ets_simple = ETS(ratio ~ error("A") +
                    trend() + season("N"))) 

fit_model <- forecast(ts_model, h = 6)

projected_ratios <- fit_model %>%
  hilo(95) %>%
  mutate(ratio_lower = `95%`$lower,
         ratio_upper = `95%`$upper) %>%
  mutate(year = floor(date_index),
         month = 1 + (date_index - year) * 12) %>%
  mutate(date = as.Date(paste0(year, "-", month, "-", "01"))) %>%
  data.frame() %>%
  select(gss_code, gss_name,
         geography, sex,
         date,
         model = .model,
         ratio = .mean,
         ratio_lower,
         ratio_upper) %>%
  interpolate_gp_ratios(dt_min = dt_end,
                        w_intervals = TRUE)

```

```{r plot actual and projected ratios, echo=FALSE}

gp_ratios %>%
  filter(gss_code %in% plt_gss) %>%
  filter(between(date, dt_earliest_to_use, dt_end)) %>%
  ggplot(aes(x = date, y = ratio, colour = gss_name, fill = gss_name)) +
  theme_gla(free_y_facets = TRUE, gla_theme = "inverse") +
  geom_vline(xintercept = dt_end, linetype = "dashed", colour = "grey") +
  geom_point(shape = 1) +
  ggla_line(alpha = 0.3) +
  geom_ribbon(data = projected_ratios, 
              aes(alpha = 0.2, ymin = ratio_lower, ymax = ratio_upper)) +
  geom_line(data = projected_ratios, linewidth = 1) +
  scale_x_date(labels = label_date_short()) +
  theme(legend.position = "none") +
  labs(title = "Actual and forecast ratios",
       subtitle = "Mean predicted ratios and 95% intervals",
       caption = "Forecast using Fable's ETS exponential smoothing method") +
  facet_wrap("gss_name")
```

```{r predict births, include=FALSE}

  predicted_births <- projected_ratios %>%
    inner_join(gp_0, by = c("gss_code", "gss_name", "geography", "sex", "date")) %>%
    mutate(value = round(ratio * gp_count, 1),
           interval_lower = round(ratio_lower * gp_count, 1),
           interval_upper = round(ratio_upper * gp_count, 1)) %>%
    select(-c(ratio, ratio_lower, ratio_upper, gp_count, model)) %>%
    mutate(measure = "predicted") 

```

Predicted recent births for each area are calculated as the product of recent patient register counts and forecast ratios. 

```{r actual and predicted birth plot, echo=FALSE}

births_actual %>%
  rename(value = annual_births) %>%
  mutate(measure = "actual") %>%
  filter(gss_code %in% plt_gss) %>%
  filter(between(date, dt_earliest_to_use, dt_end)) %>%
  ggplot(aes(x = date, y = value/1000, colour = gss_name, fill = gss_name)) +
  theme_gla(free_y_facets = TRUE, gla_theme = "inverse") +
  geom_vline(xintercept = dt_end, linetype = "dashed", colour = "grey") +
  geom_point(shape = 1, stroke = 0.75) +
  ggla_line(alpha = 0.3) +
  geom_ribbon(data = predicted_births, 
              aes(alpha = 0.1, 
                  ymin = interval_lower/1000, ymax = interval_upper/1000)) +
  scale_x_date(labels = label_date_short()) +
  theme(legend.position = "none") +
  labs(title = "Actual and predicted births",
       subtitle = "(thousands), shaded region represents 95% prediction interval",
       caption = paste0("Date of last actual births used in prediction: ", dt_end)) +
  facet_wrap("gss_name", scales = "free_y")

```

# Potential improvements

##### Incorporate monthly annual birth estimates

Currently only actual births for mid and calendar year periods are used to calculate past ratios. Monthly annual birth estimates for recent years could be constructed directly from official monthly birth estimates that ONS publish as semi-regular ad-hoc releases. This is currently listed as a TODO in [collate birth data](https://github.com/Greater-London-Authority/collate-birth-data). 

Including monthly actual data would:

* greatly increase the number of data points available as a basis for forecasting ratios and cross validation
* remove the need to interpolate monthly ratios from the 6 monthly data
* increase potential to account for seasonality in the ratios
* extend the approach to create estimates of recent births by month (rather than annual births by month of year ending)

# Assessing accuracy of birth predictions

A given set of birth predictions can be compared with subsequent actuals once they become available.   

```{r compare actual predicted births plot, echo=FALSE}

births_actual %>%
  rename(value = annual_births) %>%
  mutate(measure = "actual") %>%
  filter(gss_code %in% plt_gss) %>%
  filter(date >= dt_end - months(36)) %>%
  ggplot(aes(x = date, y = value/1000, colour = gss_name, fill = gss_name)) +
  theme_gla(free_y_facets = TRUE, gla_theme = "inverse") +
  geom_vline(xintercept = dt_end, linetype = "dashed", colour = "grey") +
  geom_ribbon(data = predicted_births, 
              aes(alpha = 0.1, ymin = interval_lower/1000, ymax = interval_upper/1000)) +
  geom_line(data = predicted_births, linetype = "dashed") +
  geom_point(shape = 1, colour = "yellow", stroke = 1) +
  scale_x_date(labels = label_date_short()) +
  theme(legend.position = "none") +
  labs(title = "Comparison of predicted births with subsequent actuals",
       subtitle = "(thousands), shaded region represents 95% prediction interval",
       caption = paste0("Date of last actual births used in prediction: ", dt_end)) +
  facet_wrap("gss_name", scales = "free_y")

```

To assess the overall accuracy of the predictions, we can produce and analyse multiple sets of predictions based on the data available at different points in the past. To provide context, accompanying sets of 'naive' predictions are produced using the simple method of predicting future annual births in an area will be the same as the last actual estimate.  

This approach provides an indication of how the accuracy of predictions might be expected to vary, e.g.: over time, by distance from last actual data, by geographical area. In addition, this approach allows an empirical assessment of the reliability of the stated prediction intervals estimated by the model.

```{r create cross validation data, include=FALSE}

birth_comparisons <- lapply(dates_project_from, create_projection_set,
                            max_horizon = max_horizon,
                            dt_earliest_to_use = dt_earliest_to_use,
                            gp_ratios = gp_ratios,
                            births_actual = births_actual,
                            gp_0 = gp_0)

forecast_errors <- lapply(birth_comparisons, calculate_forecast_errors) %>%
  bind_rows() %>%
  mutate(model = recode(model, 
                        "ETS" = "Modelled",
                        "naive" = "Naive"))

mean_errors <- calculate_mean_errors(forecast_errors)

proportions_within_interval <- calculate_proportion_within_interval(birth_comparisons) 

```

## Accuracy by geography and forecast horizon

The mean accuracy of modelled births is strongly dependent on geography, with predictions for local authority districts being far less accurate than those for higher level geographies. For districts, accuracy appears to decrease gradually with forecast horizon, though the relationship is unclear for larger geographies.

Births modelled using patient count data proved to be far more accurate than naive prediction.  In contrast to the modelled data, the accuracy of the naive predictions showed much less variation by geography, but rapidly declined as the forecast horizon increased.

```{r mean errors by horizon, echo=FALSE, fig.show='hold'}

plot_mean_errors <- function(sel_model, mean_errors) {
  
  plt <- mean_errors %>%
    filter(model == sel_model) %>%
    ggplot(aes(x = horizon, y = MAPE, fill = geography, group = geography)) +
    theme_gla(free_y_facets = TRUE, gla_theme = "inverse", 
              x_axis_title = TRUE, y_axis_title = TRUE) +
    ggla_horizbar(position = "dodge") +
    scale_x_continuous(breaks = c(6, 12, 18, 24, 30, 36, 42)) +
    scale_y_continuous(n.breaks = 8) +
    labs(title = "Prediction accuracy by forecast horizon",
         subtitle = paste0(sel_model, " prediction")) +
    xlab("Horizon (months)") +
    ylab("Mean Absolute Percentage Error")
  
  return(plt)
}

plot_mean_errors("Modelled", mean_errors)
plot_mean_errors("Naive", mean_errors)

```

```{r accuracy boxplots, echo=FALSE}

plot_err_boxplot <- function(sel_geog, forecast_errors,
                             gss_exclude = c("E09000001", "E06000053")){
  
  errors_df <- forecast_errors %>%
    bind_rows() %>%
    filter(!gss_code %in% gss_exclude) %>%
    filter(grepl(sel_geog, geography)) 
  
  number_areas <- length(unique(errors_df$gss_code))
  number_runs <- length(unique(errors_df$projection_date))
  
  plt <- errors_df %>%
    ggplot(aes(x = horizon, y = perc_err/100, group = interaction(horizon, model), fill = model)) +
    theme_gla(free_y_facets = TRUE, gla_theme = "inverse",
              x_axis_title = TRUE, y_axis_title = TRUE) +
    geom_hline(yintercept = 0, linetype = "dotted", colour = "white") +
    geom_boxplot(outlier.alpha = 0.3,
                 outlier.color = "grey",
                 color = "white") +
    scale_y_continuous(labels = scales::label_percent()) +
    scale_x_continuous(breaks = c(6, 12, 18, 24, 30, 36, 42)) +
    xlab("Horizon (months)") +
    ylab("Prediction error") +
    labs(title = paste0("Prediction accuracy for ", sel_geog, " areas"),
         subtitle = paste0("Number of areas: ", number_areas, "; Number prediction sets: ", number_runs)) 

  return(plt)
}

plot_err_boxplot("CTRY", forecast_errors)
plot_err_boxplot("RGN", forecast_errors)
plot_err_boxplot("ITL", forecast_errors)
plot_err_boxplot("LAD", forecast_errors)

```

## Accuracy over time

The mean accuracy of the modelled births for a given forecast horizon and geography have remained relatively consistent (within ~0.5% MAPE) over successive sets of predictions. Accuracy of the naive predictions varied by a much greater degree over time.

```{r accuracy over time, echo=FALSE}

plot_accuracy_over_time <- function(sel_model, mean_errors) {
  
  plt <- mean_errors %>%
    filter(model == sel_model) %>%
    ggplot(aes(x = projection_date, y = MAPE/100, colour = geography, shape = geography)) +
    theme_gla(free_y_facets = TRUE, gla_theme = "inverse",
              x_axis_title = TRUE, y_axis_title = TRUE) +
    geom_point() +
    ggla_line(alpha = 0.5) +
    scale_x_date(breaks = dates_project_from, labels = label_date_short()) +
    scale_y_continuous(labels = scales::label_percent(), limits = c(0,NA)) +
    labs(title = "Prediction accuracy over time",
         subtitle = paste0(sel_model, " predictions")) +
    ylab("Mean absolute percentage error") +
    xlab("Date of last actual birth estimate") +
    facet_wrap("horizon", ncol = 4)
  
  return(plt)
}

plot_accuracy_over_time("Modelled", mean_errors)
plot_accuracy_over_time("Naive", mean_errors)

```

## Reliability of stated prediction intervals

The modelled births are currently produced with a stated 95% prediction interval. This interval is determined by the estimated prediction interval for the forecast ratios produced by the time series model (as predicted births are proportional to the forecast ratios). 

To test the reliability of the estimated intervals we count the proportion of subsequent actual births that sat within the stated interval across all sets of predictions.

This shows that the stated ranges underestimate the true 95% prediction intervals for all geographies.  

```{r proportion within prediction interval, echo=FALSE}

proportions_within_interval %>%
  mutate(geog_n = paste0(str_sub(geography, 1, -3), " (n=", number_areas, ")")) %>%
  ggplot(aes(x = geog_n, y = prop_within_interval, fill = reorder(geog_n, number_areas))) +
  theme_gla(free_y_facets = TRUE, gla_theme = "inverse") +
  
  ggla_horizbar(position = "dodge", alpha = 0.9) + 
  geom_text(aes(label = 100 * round(prop_within_interval, 3)), colour = "white", hjust = + 2) +
  geom_hline(yintercept = 0.95, colour = "white", linetype = "dashed") +
  scale_y_continuous(n.breaks = 9, labels = scales::label_percent()) +
    labs(title = "Proportion actual births within prediction interval",
       subtitle = "Stated prediction interval: 95%") 

```
